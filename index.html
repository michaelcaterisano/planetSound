<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PlanetSound</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link rel="icon" type="image/png" sizes="174x174" href="./favicon.png" />

    <script src="https://unpkg.com/@webcomponents/webcomponentsjs@^2/webcomponents-bundle.js"></script>
    <script src="node_modules/tone/build/Tone.js"></script>
    <script src="node_modules/@tonejs/ui/build/tonejs-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
    <script src="astronomy.js"></script>
    <style type="text/css">
      tone-play-toggle {
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <style>
      #channels-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        max-width: 600px;
      }
      #date-container {
        text-align: center;
      }

      #planet-container {
        width: 33%;
        margin-bottom: 20px;
      }
      tone-play-toggle {
        width: 100%;
      }

      #planet-container tone-channel {
        flex-grow: 1;
        width: 100%;
      }
      .frequency-label {
        display: flex;
        font-size: 9px;
        width: 100%;
        justify-content: center;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      tone-slider {
        width: 100%;
        margin-bottom: 10px;
      }
    </style>
    <tone-content>
      <!-- <div id="mercury"></div> -->
      <!-- <div id="venus"></div> -->
    </tone-content>

    <tone-content>
      <tone-explanation label="Planet Sound">
        Planet distances from Earth on <br />
        <strong><span id="date"></span></strong><br />
        represented as sound from 430Hz to 3520Hz<br /><br />

        Use the slider to increase the speed of time <br /><br />
        Built by Michael Caterisano using
        <a href="https://tonejs.github.io/">tone.js</a>,
        <a href="https://github.com/Tonejs/ui">tone.js/ui</a> and
        <a href="http://cosinekitty.com/astronomy.js"
          >astronomy.js</a
        > </tone-explanation
      ><br />

      <div id="channels-container">
        <tone-play-toggle></tone-play-toggle>
        <tone-slider
          label="speed of time"
          min="1"
          max="10000000"
          value="1"
        ></tone-slider>

        <div id="planet-container">
          <div id="earth-distance" class="frequency-label"></div>
          <div id="earth-frequency" class="frequency-label"></div>

          <tone-channel label="earth" id="earth-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="mercury-distance" class="frequency-label"></div>
          <div id="mercury-frequency" class="frequency-label"></div>

          <tone-channel label="mercury" id="mercury-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="venus-distance" class="frequency-label"></div>
          <div id="venus-frequency" class="frequency-label"></div>
          <tone-channel label="venus" id="venus-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="sun-distance" class="frequency-label"></div>
          <div id="sun-frequency" class="frequency-label"></div>
          <tone-channel label="sun" id="sun-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="mars-distance" class="frequency-label"></div>
          <div id="mars-frequency" class="frequency-label"></div>
          <tone-channel label="mars" id="mars-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="jupiter-distance" class="frequency-label"></div>
          <div id="jupiter-frequency" class="frequency-label"></div>
          <tone-channel label="jupiter" id="jupiter-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="saturn-distance" class="frequency-label"></div>
          <div id="saturn-frequency" class="frequency-label"></div>
          <tone-channel label="saturn" id="saturn-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="uranus-distance" class="frequency-label"></div>
          <div id="uranus-frequency" class="frequency-label"></div>
          <tone-channel label="uranus" id="uranus-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="neptune-distance" class="frequency-label"></div>
          <div id="neptune-frequency" class="frequency-label"></div>
          <tone-channel label="neptune" id="neptune-channel"></tone-channel>
        </div>
      </div>

      <!-- <tone-channel label="mercury" id="mercury"></tone-channel>
      <tone-channel label="venus" id="venus"></tone-channel> -->
    </tone-content>

    <script type="text/javascript">
      // VARS
      let isPlaying = false;
      let loopToggleId = null;
      let speedOfTime = null;
      let y2k = moment({ year: 2000, month: 0, day: 0 });
      let date = moment();

      // intialize date in UI
      let days = daysSince(y2k, date);
      let titleDate = document.querySelector("#date");
      titleDate.innerText = `${date.format("MMM DD YYYY")}`;

      // FUNCTIONS
      function daysSince(date1, date2) {
        var ms_in_one_day = 1000 * 60 * 60 * 24;
        var difference_ms = date2 - date1;
        console.log(difference_ms / ms_in_one_day);
        return difference_ms / ms_in_one_day;
      }

      function makeChannel(name, osc) {
        const channel = new Tone.Channel({ volume: -25 }).toMaster();
        osc.chain(channel);
        document.querySelector(`#${name}-channel`).bind(channel);
      }

      function getNumberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      function updateDistanceDisplay(name, distance) {
        let node = document.querySelector(`#${name}-distance`);
        node.innerText = `${distance} km`;
      }
      function updateFrequencyDisplay(name, frequency) {
        let node = document.querySelector(`#${name}-frequency`);
        node.innerText = `${frequency.toFixed(10)} Hz`;
      }
      function togglePlaying(id) {
        if (isPlaying) {
          clearInterval(id);
          isPlaying = false;
          return;
        } else {
          loopToggleId = setInterval(updateFrequencies, 10);
          isPlaying = true;
        }
      }

      /*** UPDATE function ***/
      function updateFrequencies() {
        document.querySelector("tone-slider").addEventListener("change", e => {
          speedOfTime = e.detail;
        });
        let frequencies = getFrequencies(days);
        days = daysSince(y2k, date);

        /*** CONTROL SPEED THROUGH TIME HERE ***/
        // move to current time on each call
        // let now = moment();
        //date = now;

        // move forward one day on each call
        if (speedOfTime === null) {
          date = moment();
        } else {
          date.add(10 * speedOfTime, "milliseconds"); // alternatively move through time one day per function call
        }

        // update titleDate in UI
        document.querySelector("#date").innerText = `${date.format(
          "MMM DD YYYY HH:mm:ss:SS"
        )}`;

        // update planet distances in UI
        const planetNames = Object.keys(frequencies);
        for (let i = 0; i < planetNames.length; i++) {
          let planet = planetNames[i];
          let frequency = frequencies[planet]; // alternatively display frequency
          let distance = getDistanceKM(planet).toFixed(3);
          let distanceFormatted = getNumberWithCommas(distance);
          updateDistanceDisplay(planet, distanceFormatted);
          updateFrequencyDisplay(planet, frequency);
        }

        // update oscillator values
        earthOscillator.frequency.value = frequencies["earth"];
        mercuryOscillator.frequency.value = frequencies["mercury"];
        venusOscillator.frequency.value = frequencies["venus"];
        sunOscillator.frequency.value = frequencies["sun"];
        marsOscillator.frequency.value = frequencies["mars"];
        jupiterOscillator.frequency.value = frequencies["jupiter"];
        saturnOscillator.frequency.value = frequencies["saturn"];
        uranusOscillator.frequency.value = frequencies["uranus"];
        neptuneOscillator.frequency.value = frequencies["neptune"];
      }

      // CREATE OSCILLATORS
      let earthOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let mercuryOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let venusOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let marsOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let jupiterOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let saturnOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let uranusOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let neptuneOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let sunOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);

      // CREATE THE CHANNELS
      makeChannel("earth", earthOscillator);
      makeChannel("mercury", mercuryOscillator);
      makeChannel("venus", venusOscillator);
      makeChannel("sun", sunOscillator);
      makeChannel("mars", marsOscillator);
      makeChannel("jupiter", jupiterOscillator);
      makeChannel("saturn", saturnOscillator);
      makeChannel("uranus", uranusOscillator);
      makeChannel("neptune", neptuneOscillator);

      // bind toggle button to UI
      const toggle = document.querySelector("tone-play-toggle");
      toggle.bind(Tone.Transport);

      // bind click handler
      toggle.onclick = function(e) {
        e.preventDefault();
        togglePlaying(loopToggleId);
      };
    </script>
  </body>
</html>
