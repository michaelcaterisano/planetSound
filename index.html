<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Oscillator</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link rel="icon" type="image/png" sizes="174x174" href="./favicon.png" />

    <script src="https://unpkg.com/@webcomponents/webcomponentsjs@^2/webcomponents-bundle.js"></script>
    <script src="node_modules/tone/build/Tone.js"></script>
    <script src="node_modules/@tonejs/ui/build/tonejs-ui.js"></script>
    <script src="astronomy.js"></script>
    <style type="text/css">
      tone-play-toggle {
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <style>
      #channels-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        max-width: 600px;
      }
      #date {
        display: flex;
        font-size: 20px;
        margin: 20px;
      }
      #planet-container {
        width: 33%;
        margin-bottom: 20px;
      }
      tone-play-toggle {
        width: 100%;
      }

      #planet-container tone-channel {
        flex-grow: 1;
        width: 100%;
      }
      .frequency-label {
        display: flex;
        font-size: 9px;
        width: 100%;
        justify-content: center;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    </style>
    <tone-content>
      <!-- <div id="mercury"></div> -->
      <!-- <div id="venus"></div> -->
    </tone-content>

    <tone-content>
      <div id="channels-container">
        <div id="date"></div>

        <tone-play-toggle></tone-play-toggle>

        <div id="planet-container">
          <div id="earth" class="frequency-label"></div>

          <tone-channel label="earth" id="earth-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="mercury" class="frequency-label"></div>
          <tone-channel label="mercury" id="mercury-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="venus" class="frequency-label"></div>
          <tone-channel label="venus" id="venus-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="sun" class="frequency-label"></div>
          <tone-channel label="sun" id="sun-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="mars" class="frequency-label"></div>
          <tone-channel label="mars" id="mars-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="jupiter" class="frequency-label"></div>
          <tone-channel label="jupiter" id="jupiter-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="saturn" class="frequency-label"></div>
          <tone-channel label="saturn" id="saturn-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="uranus" class="frequency-label"></div>
          <tone-channel label="uranus" id="uranus-channel"></tone-channel>
        </div>
        <div id="planet-container">
          <div id="neptune" class="frequency-label"></div>
          <tone-channel label="neptune" id="neptune-channel"></tone-channel>
        </div>
      </div>

      <!-- <tone-channel label="mercury" id="mercury"></tone-channel>
      <tone-channel label="venus" id="venus"></tone-channel> -->
    </tone-content>

    <script type="text/javascript">
      // VARS
      let isPlaying = false;
      let loopToggleId = null;
      let y2k = new Date(2000, 0, 1);
      let date = new Date();

      // intialize date
      let days = daysSince(y2k, date);
      let dateNode = (document.querySelector(
        "#date"
      ).innerText = `Planet distances ${date.toDateString().slice(4)}`);

      // HELPER FUNCTIONS
      function daysSince(date1, date2) {
        //Get 1 day in milliseconds
        var one_day = 1000 * 60 * 60 * 24;

        // Convert both dates to milliseconds
        var date1_ms = date1.getTime();
        var date2_ms = date2.getTime();

        // Calculate the difference in milliseconds
        var difference_ms = date2_ms - date1_ms;

        // Convert back to days and return
        return difference_ms / one_day;
      }

      function makeChannel(name, osc) {
        const channel = new Tone.Channel({ volume: -25 }).toMaster();
        osc.chain(channel);
        //bind the UI
        document.querySelector(`#${name}-channel`).bind(channel);
      }

      function numberWithCommas(x) {
        console.log(x);
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      function makeFreqDisplay(name, frequency) {
        // if (name === "earth") {
        //   let node = document.querySelector(`#${name}`);
        //   node.innerText = `${frequency} km`;
        //   return;
        // }f
        let node = document.querySelector(`#${name}`);
        node.innerText = `${frequency} km`;
      }

      /*** THE MEAT ***/
      function updateFrequencies() {
        let frequencies = getFrequencies(days);
        days = daysSince(y2k, date);

        /*** CONTROL SPEED THROUGH TIME HERE ***/

        //normal speed
        let now = new Date();
        date = now;

        // fast
        // date.setDate(date.getDate() + 1); // alternatively move through time one day per function call

        // update date in UI
        document.querySelector(
          "#date"
        ).innerText = `Planet distances ${date.toDateString().slice(4)}`;

        // get array of planet names
        const planetNames = Object.keys(frequencies);

        // update each planet distance in UI
        for (let i = 0; i < planetNames.length; i++) {
          let planet = planetNames[i];
          //let frequency = frequencies[planet]; // alternatively display frequency
          let distance = getDistanceKM(planet).toFixed(3);
          let distanceFormatted = numberWithCommas(distance);
          makeFreqDisplay(planet, distanceFormatted);
        }

        // update oscillator values
        earthOscillator.frequency.value = frequencies["earth"];
        mercuryOscillator.frequency.value = frequencies["mercury"];
        venusOscillator.frequency.value = frequencies["venus"];
        sunOscillator.frequency.value = frequencies["sun"];
        marsOscillator.frequency.value = frequencies["mars"];
        jupiterOscillator.frequency.value = frequencies["jupiter"];
        saturnOscillator.frequency.value = frequencies["saturn"];
        uranusOscillator.frequency.value = frequencies["uranus"];
        neptuneOscillator.frequency.value = frequencies["neptune"];
      }

      // CREATE OSCILLATORS
      let earthOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let mercuryOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let venusOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let marsOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let jupiterOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let saturnOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let uranusOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let neptuneOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);
      let sunOscillator = new Tone.Oscillator({
        type: "sine"
      })
        .sync()
        .start(0);

      // CREATE THE CHANNELS
      makeChannel("earth", earthOscillator);
      makeChannel("mercury", mercuryOscillator);
      makeChannel("venus", venusOscillator);
      makeChannel("sun", sunOscillator);
      makeChannel("mars", marsOscillator);
      makeChannel("jupiter", jupiterOscillator);
      makeChannel("saturn", saturnOscillator);
      makeChannel("uranus", uranusOscillator);
      makeChannel("neptune", neptuneOscillator);

      // BIND THE TOGGLE BUTTON
      const toggle = document.querySelector("tone-play-toggle");
      toggle.bind(Tone.Transport);

      function togglePlaying(id) {
        if (isPlaying) {
          clearInterval(id);
          isPlaying = false;
          return;
        } else {
          loopToggleId = setInterval(updateFrequencies, 10);
          isPlaying = true;
        }
      }

      // set play button onclick handler
      toggle.onclick = function(e) {
        e.preventDefault();
        togglePlaying(loopToggleId);
      };
    </script>
  </body>
</html>
